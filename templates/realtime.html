<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="../static/css/nav.css" />
    <link rel="stylesheet" href="../static/css/slideshow.css" />
    <link rel="stylesheet" href="../static/css/hospital.css" />
    <link rel="stylesheet" href="../static/css/analytics.css" />
    <!-- Add Three.js library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
    <title>DRONOS</title>
    <style>
      .container2 {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 2.5%;
        margin-left: 2%;
        width: 95%;
      }

      .card {
        flex: 1;
        height: 300px;
        background-color: #f8f8f8;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        border-radius: 30px;
        text-align: center;
        margin: 0 20px;
        transition: box-shadow 0.3s ease;
      }

      #droneContainer {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 500px;
      }

      .container2 .card:hover {
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
      }

      .card p {
        font-size: 24px;
        margin: 10px 0;
        margin-top: 10%;
      }
    </style>
  </head>
  <body style="background-color: black">
    <nav style="font-family: Arial, Helvetica, sans-serif">
      <a
        id="clicktohome"
        href="/"
        style="
          width: 20%;
          float: left;
          position: relative;
          text-align: center;
          padding-top: 1.4%;
          font-family: Hanson-Bold;
          font-size: 75px;
        "
        >DRONOS</a
      >
      <ul
        style="
          width: 35%;
          float: right;
          margin-right: 50px;
          text-align: center;
          margin-top: 20px;
          font-family: Arial, Helvetica, sans-serif;
        "
      >
        <li><a href="analytics">Analytics</a></li>
        <li><a href="hardware">Hardware</a></li>

        <li><a href="about">Contact Us</a></li>
      </ul>
    </nav>

    <div
      class="slideshow-container2"
      style="
        font-family: Arial, Helvetica, sans-serif;
        height: 30vh;
        margin-top: 10%;
      "
    >
      <div class="mySlides fade" style="height: 30vh">
        <div
          id="initial_container"
          style="
            font-size: 150px;
            color: white;
            text-align: center;
            margin-left: 0%;
            margin-top: 10%;
            padding-top: 1.5%;
            height: 10vh;
          "
        >
          REALTIME <br />
          ANALYTICS
        </div>
      </div>
    </div>

    <div id="droneContainer" style="width: 100%; height: 500px"></div>

    <div
      class="analytics-container2"
      style="font-family: Arial, Helvetica, sans-serif; z-index: 0"
    >
      <div class="container2" style="font-family: Circular">
        <div
          class="card"
          style="
            background-image: url(../static/assets/aesthetic-colorful-yellow-and-green-gradient-background-illustration-perfect-for-wallpaper-background-backdrop-banner-vector.jpg);
            background-size: cover;
          "
        >
        <p style="font-size: 50px; line-height: 30px">Temperature</p>

          <p style="font-size: 90px">{{ data['val1'] }}Â°C</p>
        </div>
        <div
          class="card"
          style="
            background-image: url(../static/assets/aesthetic-colorful-yellow-and-green-gradient-background-illustration-perfect-for-wallpaper-background-backdrop-banner-vector.jpg);
            background-size: cover;
          "
        >
        <p style="font-size: 50px; line-height: 40px">Humidity</p>
          <p style="font-size: 90px">{{ data['val2'] }}</p>
        </div>
        <div
          class="card"
          style="
            background-image: url(../static/assets/aesthetic-colorful-yellow-and-green-gradient-background-illustration-perfect-for-wallpaper-background-backdrop-banner-vector.jpg);
            background-size: cover;
          "
        >
          <p style="font-size: 50px; line-height: 30px">AQI</p>
          <p style="font-size: 90px">{{ data['val3'] }}</p>
        </div>

        <div
          class="card"
          style="
            background-image: url(../static/assets/aesthetic-colorful-yellow-and-green-gradient-background-illustration-perfect-for-wallpaper-background-backdrop-banner-vector.jpg);
            background-size: cover;
          "
        >
          <p style="font-size: 50px; line-height: 30px">Altitude</p>
          <p style="font-size: 90px">{{ data['val4']/100 }}m</p>
        </div>
      </div>

      <div class="charts-container">
        <div id="altitudePlot"></div>
        <div id="trajectoryPlot"></div>
      </div>

      <!-- {% if data %}
            <p>Value 1: {{ data['val1'] }}</p>
            <p>Value 2: {{ data['val2'] }}</p>
            <p>Value 3: {{ data['val3'] }}</p>
        {% else %}
            <p>Failed to fetch realtime data.</p>
        {% endif %} -->
    </div>

    <div
      class="slideshow-container"
      style="
        font-family: Arial, Helvetica, sans-serif;
        background-image: url(../static/assets/dji-mavic-air-2-review-Pat-Kay-Blog-09015_1920x.webp);
      "
    >
      <div id="initial_container_2" style="text-align: center">
        MODULE FOR DRONE
      </div>
    </div>

    <div class="flex-container" style="margin-top: 20px; height: 700px">
      <div class="flex-item">
        <a
          style="text-decoration: none; color: white"
          href="analytics"
          target="_self"
        >
          <p class="text-container1" style="font-size: 70px">ANALYTICS</p>
        </a>
      </div>
      <div class="flex-item">
        <a
          style="text-decoration: none; color: white"
          href="hardware"
          target="_self"
        >
          <p class="text-container1" style="font-size: 70px">HARDWARE</p>
        </a>
      </div>
      <div class="flex-item">
        <a
          style="text-decoration: none; color: white"
          href="about"
          target="_self"
        >
          <p class="text-container1" style="font-size: 70px">ABOUT US</p>
        </a>
      </div>
    </div>

    <script>
      let slideIndex = 1;
      showSlides(slideIndex);

      function plusSlides(n) {
        showSlides((slideIndex += n));
      }

      function currentSlide(n) {
        showSlides((slideIndex = n));
      }

      function showSlides(n) {
        let i;
        let slides = document.getElementsByClassName("mySlides");
        let dots = document.getElementsByClassName("dot");
        if (n > slides.length) {
          slideIndex = 1;
        }
        if (n < 1) {
          slideIndex = slides.length;
        }
        for (i = 0; i < slides.length; i++) {
          slides[i].style.display = "none";
        }
        for (i = 0; i < dots.length; i++) {
          dots[i].className = dots[i].className.replace(" active", "");
        }
        slides[slideIndex - 1].style.display = "block";
        // dots[slideIndex - 1].className += " active";
      }

      // Change slides automatically every 3 seconds
      setInterval(function () {
        plusSlides(1);
      }, 4000);

      // Function to create and update the rotating box
      function createRotatingBox(val1, val2, val3) {
        // Create a scene
        var scene = new THREE.Scene();

        // Create a camera
        var camera = new THREE.PerspectiveCamera(
          75,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );

        // Adjust the camera position to center the box
        camera.position.x = 0;
        camera.position.y = 0;
        camera.position.z = 5;

        // Specify the desired dimensions for the canvas
        var canvasWidth = 1080; // Set your desired width
        var canvasHeight = 600; // Set your desired height

        // Create a WebGLRenderer with the specified dimensions
        var renderer = new THREE.WebGLRenderer();
        renderer.setSize(canvasWidth, canvasHeight);
        document
          .getElementById("droneContainer")
          .appendChild(renderer.domElement);

        // Create a box
        var initialBoxSize = 1; // Set the initial size of the box
        var geometry = new THREE.BoxGeometry(
          initialBoxSize,
          initialBoxSize,
          initialBoxSize
        );
        var material = new THREE.MeshBasicMaterial({ color: 0x00ff00 });
        var box = new THREE.Mesh(geometry, material);
        scene.add(box);

        // Set the initial box rotation based on the values
        box.rotation.x = val1; // inclination from x-axis in radians
        box.rotation.y = val2; // inclination from y-axis in radians
        box.rotation.z = val3; // inclination from z-axis in radians

        // Center the box in the scene
        box.position.set(0, 0, 0);

        // Set the scale of the box to maintain proportions
        var scaleValue = 3; // Change this value to control the scale
        box.scale.set(scaleValue, scaleValue, scaleValue);

        // Update camera aspect ratio
        camera.aspect = canvasWidth / canvasHeight;
        camera.updateProjectionMatrix();

        // Update camera position to look at the center of the scene
        camera.lookAt(scene.position);

        // Render the scene
        renderer.render(scene, camera);
      }

      // Call the function with sample values (replace with your actual values)
      createRotatingBox(0.1, 0.2, 0.3);

      let currentPosition = { x: 0, y: 0, z: 0 };
      let radialVelocity = { x: 0, y: 0, z: 0 };
      let acceleration = { x: 0, y: 0, z: 0 };
      let isFetching = false; // Variable to track whether a fetch operation is in progress

      let trajectoryData = [];

      const dt = 1;

      function calculateNextPosition(
        currentPosition,
        radialVelocity,
        acceleration
      ) {
        let newVelocity = {
          x: radialVelocity.x + acceleration.x * dt,
          y: radialVelocity.y + acceleration.y * dt,
          z: radialVelocity.z + acceleration.z * dt,
        };

        let newPosition = {
          x: currentPosition.x + newVelocity.x * dt,
          y: currentPosition.y + newVelocity.y * dt,
          z: currentPosition.z + newVelocity.z * dt,
        };

        return newPosition;
      }

      let trajectoryPlot = document.getElementById("trajectoryPlot");
      let trajectoryCanvas = document.createElement("canvas");
      trajectoryCanvas.width = 1000;
      trajectoryCanvas.height = 500;
      trajectoryCanvas.id = "trajectoryChart";
      trajectoryPlot.appendChild(trajectoryCanvas);
      let ctx = document.getElementById("trajectoryChart").getContext("2d");
      let lastPoints = [];
      let chart = new Chart(ctx, {
        type: "scatter",
        data: {
          datasets: [
            {
              label: "Trajectory Data",
              data: [],
              backgroundColor: "rgba(75, 192, 192, 0.2)",
              borderColor: "rgba(75, 192, 192, 1)",
              borderWidth: 1,
              pointRadius: 5,
              pointHoverRadius: 8,
              pointBackgroundColor: "rgba(75, 192, 192, 1)",
              showLine: true,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            backgroundColor: "rgba(72,72,72, 0.4)",
          },
        },
      });

      function animatePlot() {
        if (!isFetching) {
          isFetching = true;

          fetch("/getGyroData")
            .then((response) => response.json())
            .then((data) => {
              const newRadialVelocity = {
                x: parseFloat(data["gx"]) || 0,
                y: parseFloat(data["gy"]) || 0,
                z: parseFloat(data["gz"]) || 0,
              };
              const newAcceleration = {
                x: parseFloat(data["ax"]) || 0,
                y: parseFloat(data["ay"]) || 0,
                z: parseFloat(data["az"]) || 0,
              };

              currentPosition = calculateNextPosition(
                currentPosition,
                newRadialVelocity,
                newAcceleration
              );

              const newPoint = { x: currentPosition.x, y: currentPosition.y };

              const isUniquePoint = lastPoints.every(
                (point) =>
                  Math.abs(point.x - newPoint.x) > 0.0001 ||
                  Math.abs(point.y - newPoint.y) > 0.0001
              );

              if (isUniquePoint) {
                trajectoryData.push({
                  x: currentPosition.x,
                  y: currentPosition.y,
                });
                lastPoints.push(newPoint);
                if (lastPoints.length > 3) {
                  lastPoints.shift();
                }
                chart.data.datasets[0].data.push(newPoint);

                // Update the chart
                chart.update();
              }
              isFetching = false;
            })
            .catch((error) => {
              console.error("Error fetching data:", error);
              isFetching = false;
            });
        }
      }

      setInterval(animatePlot, 1000);

      let sensorData = {
        droneSensors: [
          [37, 60, 87, 100],
          [39, 67, 81, 40],
          [47, 50, 97, 109],
        ],
      };

      let sensorNames = ["Temperature", "Humidity", "AQI", "Altitude"];
      let altitudePlot = document.getElementById("altitudePlot");
      altitudePlot.classList.add("sensor-container");

      let altitudeCanvas = document.createElement("canvas");
      altitudeCanvas.width = 1000;
      altitudeCanvas.height = 500;
      altitudeCanvas.id = "altitudeChart";
      altitudePlot.appendChild(altitudeCanvas);
      // document.body.appendChild(altitudePlot);

      let altitudeChart;

      function createAltitudeChart() {
        let values = sensorData["droneSensors"].map((entry) => entry[3]); // Altitude is at index 3
        let altitudeCtx = document
          .getElementById("altitudeChart")
          .getContext("2d");

        altitudeChart = new Chart(altitudeCtx, {
          type: "line",
          data: {
            labels: ["1", "2", "3", "4"],
            datasets: [
              {
                label: sensorNames[3], // Altitude label
                data: values,
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1,
                pointRadius: 5,
                pointHoverRadius: 8,
                pointBackgroundColor: "rgba(75, 192, 192, 1)",
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      function updateAltitudeData() {
        fetch("/get_data") // Assuming you have a route for fetching data
          .then((response) => response.json())
          .then((data) => {
            sensorData = data["sensorData"];
            let values = sensorData["droneSensors"].map((entry) => entry[3]); // Altitude is at index 3
            altitudeChart.data.datasets[0].data = values;
            altitudeChart.update();
          });
      }

      createAltitudeChart();
      setInterval(updateAltitudeData, 1000);
    </script>
  </body>
</html>
